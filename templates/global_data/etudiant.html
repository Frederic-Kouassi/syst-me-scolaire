{% load static %}
{% load tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
{% include 'home/includes/base.html' %}
<body>
    <div class="background"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <div class="dashboard">
        {% include 'home/includes/body.html' %}

        <main class="main-content">
            <nav class="navbar">
                <div class="page-header">
                    <a href="{% url 'user' %}"><h1 class="page-title">Espace Étudiant</h1></a>
                    <div class="page-breadcrumb">
                        <a href="{% url 'index' %}">Dashboard</a>
                        <span>/</span>
                        <span>Étudiants</span>
                    </div>
                </div>
                <div class="navbar-right">
                    <div class="search-box">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" class="search-input" placeholder="Search students...">
                    </div>
                    <button class="nav-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        <span class="notification-dot"></span>
                    </button>
                    <button class="nav-btn" id="theme-toggle" title="Toggle Light/Dark Mode">
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/>
                            <path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/>
                            <path d="M2 12h2"/><path d="M20 12h2"/>
                            <path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/>
                        </svg>
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                </div>
            </nav>

            <!-- Stats -->
            <section class="stats-grid">
                <div class="glass-card glass-card-3d stat-card">
                    <div class="stat-card-inner">
                        <div class="stat-info">
                            <h3>Total Étudiants</h3>
                            <div class="stat-value">{{ inscrit }}</div>
                            <span class="stat-change positive">+18.2%</span>
                        </div>
                        <div class="stat-icon cyan">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--emerald-light)" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="glass-card glass-card-3d stat-card">
                    <div class="stat-card-inner">
                        <div class="stat-info">
                            <h3>Visiteurs</h3>
                            <div class="stat-value">{{ visiteurs }}</div>
                            <span class="stat-change positive">+12.5%</span>
                        </div>
                        <div class="stat-icon magenta">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ══════════════════════════════════════
                 TABLEAU ÉTUDIANTS
            ══════════════════════════════════════ -->
            <section class="content-grid" style="grid-template-columns:1fr;">
                <div class="glass-card table-card glass-card-3d">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Liste des Étudiants Inscrits</h2>
                            <p class="card-subtitle">Tous les étudiants actifs de cette période</p>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nom Étudiant</th>
                                    <th>Téléphone</th>
                                    <th>Email</th>
                                    <th>Enseignant(s)</th>
                                    <th>Classe</th>
                                    <th>Matières</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eleve in etu_inscrit %}
                                <tr>
                                    <td>
                                        <div class="table-user">
                                            <div class="table-avatar" style="background:linear-gradient(135deg,var(--emerald-light),var(--emerald));">
                                                {{ eleve.etudiant.first_name|slice:":1"|upper }}{{ eleve.etudiant.last_name|slice:":1"|upper }}
                                            </div>
                                            <div class="table-user-info">
                                                <span class="table-user-name">{{ eleve.etudiant.last_name }} {{ eleve.etudiant.first_name }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ eleve.etudiant.telephone|default:"—" }}</td>
                                    <td>{{ eleve.etudiant.email|default:"—" }}</td>
                                    <td>
                                        <div style="display:flex;flex-wrap:wrap;gap:.25rem;">
                                            {% for ens in eleve.enseignants %}
                                                <span class="status-badge completed" style="font-size:.75rem;">{{ ens }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td><span class="status-badge pending">{{ eleve.classe }}</span></td>
                                    <td>
                                        <div style="display:flex;flex-wrap:wrap;gap:.25rem;max-width:200px;">
                                            {% for mat in eleve.matieres %}
                                                <span style="font-size:.75rem;padding:.25rem .5rem;background:rgba(255,255,255,.1);border-radius:6px;color:var(--text-secondary);">{{ mat }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display:flex;gap:.5rem;">
                                            <!-- ✅ Seul bouton — ouvre le bulletin via l'API -->
                                            <button class="card-btn open-bulletin-btn"
                                                    style="padding:6px 14px;font-size:.85rem;"
                                                    data-etudiant-id="{{ eleve.etudiant.id }}"
                                                    data-nom="{{ eleve.etudiant.last_name }} {{ eleve.etudiant.first_name }}"
                                                    data-classe="{{ eleve.classe }}"
                                                    data-tel="{{ eleve.etudiant.telephone|default:'' }}"
                                                    data-email="{{ eleve.etudiant.email|default:'' }}"
                                                    data-classe-id="{{ eleve.classe.id }}">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                    <circle cx="12" cy="12" r="3"/>
                                                </svg>
                                                Voir
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">
                                        Aucun étudiant inscrit pour le moment.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


            <!-- ══════════════════════════════════════
                 MODAL BULLETIN ÉTUDIANT
            ══════════════════════════════════════ -->
            <div id="bulletinModal" style="
                display:none; position:fixed; inset:0; z-index:9999;
                background:rgba(0,0,0,0.75);
                backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
                align-items:center; justify-content:center; padding:20px;
            ">
                <div style="
                    background:var(--glass-bg,#0f141e);
                    border:1px solid var(--glass-border,rgba(255,255,255,0.1));
                    border-radius:24px; width:100%; max-width:820px;
                    max-height:92vh; overflow-y:auto;
                    box-shadow:0 40px 100px rgba(0,0,0,0.6);
                ">
                    <!-- Barre accent -->
                    <div style="height:5px;background:linear-gradient(90deg,var(--emerald,#34d399),var(--gold,#fbbf24),var(--emerald,#34d399));border-radius:24px 24px 0 0;"></div>

                    <!-- En-tête -->
                    <div style="padding:28px 32px 0;display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <div style="font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--emerald-light,#6ee7b7);margin-bottom:4px;font-weight:600;">Bulletin de notes</div>
                            <div id="bul-annee"  style="font-size:13px;color:var(--text-muted,#94a3b8);"></div>
                            <div id="bul-periode" style="font-size:13px;color:var(--text-muted,#94a3b8);"></div>
                        </div>
                        <button onclick="closeBulletin()" style="
                            width:36px;height:36px;border-radius:50%;
                            background:rgba(255,255,255,0.07);
                            border:1px solid var(--glass-border,rgba(255,255,255,0.1));
                            color:var(--text-primary,#f1f5f9);font-size:20px;
                            cursor:pointer;display:flex;align-items:center;justify-content:center;
                        ">&times;</button>
                    </div>

                    <!-- Identité -->
                    <div style="margin:20px 32px;padding:20px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border,rgba(255,255,255,0.08));border-radius:16px;display:flex;align-items:center;gap:20px;">
                        <div id="bul-avatar" style="
                            width:64px;height:64px;border-radius:16px;flex-shrink:0;
                            background:linear-gradient(135deg,var(--emerald,#34d399),var(--gold,#fbbf24));
                            display:flex;align-items:center;justify-content:center;
                            font-weight:800;font-size:20px;color:#000;
                        "></div>
                        <div style="flex:1;">
                            <div id="bul-nom" style="font-size:1.3rem;font-weight:800;color:var(--text-primary,#f1f5f9);margin-bottom:6px;"></div>
                            <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                <span style="font-size:12px;color:var(--text-muted,#94a3b8);">
                                    <span style="color:var(--emerald-light,#6ee7b7);">●</span> Classe : <strong id="bul-classe-val" style="color:var(--text-secondary,#cbd5e1);"></strong>
                                </span>
                                <span style="font-size:12px;color:var(--text-muted,#94a3b8);">
                                    <span style="color:var(--gold,#fbbf24);">●</span> Tél : <strong id="bul-tel" style="color:var(--text-secondary,#cbd5e1);"></strong>
                                </span>
                                <span style="font-size:12px;color:var(--text-muted,#94a3b8);">
                                    <span style="color:#818cf8;">●</span> Email : <strong id="bul-email" style="color:var(--text-secondary,#cbd5e1);"></strong>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Stats rapides -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin:0 32px 20px;">
                        <div style="background:rgba(52,211,153,0.07);border:1px solid rgba(52,211,153,0.2);border-radius:14px;padding:16px;text-align:center;">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--emerald-light,#6ee7b7);margin-bottom:8px;font-weight:600;">Moyenne</div>
                            <div id="bul-moyenne" style="font-size:1.9rem;font-weight:800;font-family:'Space Mono',monospace;color:var(--emerald-light,#6ee7b7);">—</div>
                            <div style="font-size:10px;color:var(--text-muted,#94a3b8);margin-top:4px;">/ 20</div>
                        </div>
                        <div style="background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.2);border-radius:14px;padding:16px;text-align:center;">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--gold,#fbbf24);margin-bottom:8px;font-weight:600;">Rang</div>
                            <div id="bul-rang" style="font-size:1.9rem;font-weight:800;font-family:'Space Mono',monospace;color:var(--gold,#fbbf24);">—</div>
                            <div style="font-size:10px;color:var(--text-muted,#94a3b8);margin-top:4px;">classement</div>
                        </div>
                        <div style="background:rgba(129,140,248,0.07);border:1px solid rgba(129,140,248,0.2);border-radius:14px;padding:16px;text-align:center;">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#818cf8;margin-bottom:8px;font-weight:600;">Matières</div>
                            <div id="bul-nb-matieres" style="font-size:1.9rem;font-weight:800;font-family:'Space Mono',monospace;color:#818cf8;">—</div>
                            <div style="font-size:10px;color:var(--text-muted,#94a3b8);margin-top:4px;">évaluées</div>
                        </div>
                        <div style="background:rgba(251,113,133,0.07);border:1px solid rgba(251,113,133,0.2);border-radius:14px;padding:16px;text-align:center;">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#fb7185;margin-bottom:8px;font-weight:600;">Mention</div>
                            <div id="bul-mention" style="font-size:1rem;font-weight:800;color:#fb7185;line-height:1.3;">—</div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="bul-loading" style="display:none;text-align:center;padding:40px 32px;color:var(--text-muted,#94a3b8);">
                        <div style="font-size:13px;">⏳ Chargement du bulletin...</div>
                    </div>

                    <!-- Graphique -->
                    <div id="bul-chart-wrap" style="margin:0 32px 20px;padding:20px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border,rgba(255,255,255,0.08));border-radius:14px;">
                        <div style="font-size:13px;font-weight:600;color:var(--text-primary,#f1f5f9);margin-bottom:16px;">Résultats par matière</div>
                        <canvas id="bulNotesChart" height="140"></canvas>
                    </div>

                    <!-- Tableau des notes -->
                    <div style="margin:0 32px 20px;border:1px solid var(--glass-border,rgba(255,255,255,0.08));border-radius:14px;overflow:hidden;">
                        <div style="padding:14px 20px;background:rgba(255,255,255,0.03);border-bottom:1px solid var(--glass-border,rgba(255,255,255,0.08));">
                            <span style="font-size:13px;font-weight:600;color:var(--text-primary,#f1f5f9);">Détail des notes</span>
                        </div>
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:rgba(255,255,255,0.02);">
                                    <th style="padding:11px 20px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted,#94a3b8);font-weight:600;">Matière / Enseignant</th>
                                    <th style="padding:11px 20px;text-align:center;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted,#94a3b8);font-weight:600;">Coef.</th>
                                    <th style="padding:11px 20px;text-align:center;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted,#94a3b8);font-weight:600;">Note / 20</th>
                                    <th style="padding:11px 20px;text-align:center;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted,#94a3b8);font-weight:600;">Points</th>
                                    <th style="padding:11px 20px;text-align:center;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted,#94a3b8);font-weight:600;">Appréciation</th>
                                </tr>
                            </thead>
                            <tbody id="bul-notes-body"></tbody>
                            <tfoot>
                                <tr style="background:rgba(255,255,255,0.04);border-top:2px solid var(--glass-border,rgba(255,255,255,0.1));">
                                    <td style="padding:14px 20px;font-size:13px;font-weight:700;color:var(--text-primary,#f1f5f9);">TOTAL / MOYENNE</td>
                                    <td id="bul-total-coef"    style="padding:14px 20px;text-align:center;font-size:13px;font-weight:700;color:var(--text-muted,#94a3b8);">—</td>
                                    <td id="bul-total-moyenne" style="padding:14px 20px;text-align:center;font-size:1.1rem;font-weight:800;font-family:'Space Mono',monospace;">—</td>
                                    <td id="bul-total-points"  style="padding:14px 20px;text-align:center;font-size:13px;font-weight:700;color:var(--text-muted,#94a3b8);">—</td>
                                    <td id="bul-total-mention" style="padding:14px 20px;text-align:center;font-size:13px;font-weight:700;">—</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Appréciation générale -->
                    <div style="margin:0 32px 32px;padding:16px 20px;background:rgba(52,211,153,0.05);border:1px solid rgba(52,211,153,0.15);border-radius:12px;display:flex;align-items:center;gap:12px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--emerald-light,#6ee7b7)" stroke-width="2" style="flex-shrink:0;">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div>
                            <div style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--emerald-light,#6ee7b7);font-weight:600;margin-bottom:2px;">Appréciation du conseil de classe</div>
                            <div id="bul-appreciation-text" style="font-size:13px;color:var(--text-secondary,#cbd5e1);font-style:italic;">—</div>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <button class="mobile-menu-toggle">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6"  x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
    </button>

    <footer class="site-footer">
        <p>Copyright © 2026 <a href="#">Gestion Étudiant</a> - Système de Gestion Scolaire</p>
    </footer>

    <script src="{% static 'js/templatemo-glass-admin-script.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

    <!-- ══════════════════════════════════════
         SCRIPT UNIQUE — BULLETIN
    ══════════════════════════════════════ -->
    <script>
    (function () {
        let bulChart = null;

        /* ── Utilitaires ── */
        function noteColor(val) {
            const n = parseFloat(val);
            if (isNaN(n)) return '#94a3b8';
            if (n >= 16) return '#34d399';
            if (n >= 14) return '#6ee7b7';
            if (n >= 12) return '#fbbf24';
            if (n >= 10) return '#fb923c';
            return '#f87171';
        }

        function getMention(moy) {
            const n = parseFloat(moy);
            if (isNaN(n)) return { label: '—', color: '#94a3b8' };
            if (n >= 16) return { label: 'Très bien',  color: '#34d399' };
            if (n >= 14) return { label: 'Bien',        color: '#6ee7b7' };
            if (n >= 12) return { label: 'Assez bien',  color: '#fbbf24' };
            if (n >= 10) return { label: 'Passable',    color: '#fb923c' };
            return             { label: 'Insuffisant', color: '#f87171' };
        }

        function getAppreciation(moy) {
            const n = parseFloat(moy);
            if (isNaN(n)) return '—';
            if (n >= 16) return 'Excellent travail. Félicitations du conseil de classe.';
            if (n >= 14) return 'Très bon trimestre. Encouragements du conseil de classe.';
            if (n >= 12) return 'Bon travail, des efforts à poursuivre.';
            if (n >= 10) return 'Résultats satisfaisants, peut mieux faire.';
            return 'Résultats insuffisants. Un effort important est nécessaire.';
        }

        function escHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;').replace(/</g, '&lt;')
                .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function show(id) { document.getElementById(id).style.display = 'block'; }
        function hide(id) { document.getElementById(id).style.display = 'none';  }

        /* ── Remplir le bulletin avec les données reçues ── */
        function remplirBulletin(apiData, infos) {
            // Trouver l'étudiant dans la réponse API
            const eleve = (apiData.eleves || []).find(e => String(e.id) === String(infos.etudiantId));

            const moy   = eleve ? parseFloat(eleve.moyenne) : NaN;
            const rang  = eleve ? eleve.rang : '—';
            const notes = eleve ? (eleve.notes || []) : [];
            const mention = getMention(moy);

            // Identité
            const parts = (infos.nom || '').trim().split(' ');
            document.getElementById('bul-avatar').textContent =
                ((parts[0]?.[0] || '') + (parts[1]?.[0] || '')).toUpperCase();
            document.getElementById('bul-nom').textContent        = infos.nom    || '—';
            document.getElementById('bul-classe-val').textContent = infos.classe || '—';
            document.getElementById('bul-tel').textContent        = infos.tel    || '—';
            document.getElementById('bul-email').textContent      = infos.email  || '—';

            // Année / Période depuis l'API
            document.getElementById('bul-annee').textContent   = apiData.annee   ? 'Année : '   + apiData.annee   : '';
            document.getElementById('bul-periode').textContent = apiData.periode ? 'Période : ' + apiData.periode : '';

            // Stats
            document.getElementById('bul-moyenne').textContent     = isNaN(moy) ? '—' : moy.toFixed(2);
            document.getElementById('bul-moyenne').style.color     = mention.color;
            document.getElementById('bul-rang').textContent        = rang || '—';
            document.getElementById('bul-mention').textContent     = mention.label;
            document.getElementById('bul-mention').style.color     = mention.color;
            document.getElementById('bul-nb-matieres').textContent = notes.length;
            document.getElementById('bul-appreciation-text').textContent = getAppreciation(moy);

            // Tableau notes
            const tbody = document.getElementById('bul-notes-body');
            tbody.innerHTML = '';

            if (!notes.length) {
                tbody.innerHTML = `<tr><td colspan="5" style="padding:20px;text-align:center;color:var(--text-muted,#94a3b8);font-size:13px;">Aucune note enregistrée pour le moment.</td></tr>`;
                ['bul-total-coef','bul-total-moyenne','bul-total-points','bul-total-mention'].forEach(id => {
                    document.getElementById(id).textContent = '—';
                });
            } else {
                let totalPoints = 0;
                let totalCoef   = 0;

                notes.forEach((n, idx) => {
                    const val    = parseFloat(n.valeur);
                    const coef   = parseFloat(n.coefficient) || 1;
                    const points = isNaN(val) ? 0 : val * coef;
                    totalPoints += points;
                    totalCoef   += coef;

                    const color = noteColor(val);
                    const app   = n.appreciation || getMention(val).label;
                    const bg    = idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.015)';

                    const tr = document.createElement('tr');
                    tr.style.cssText = `background:${bg};border-bottom:1px solid rgba(255,255,255,0.06);transition:background .15s;`;
                    tr.onmouseover = () => tr.style.background = 'rgba(255,255,255,0.04)';
                    tr.onmouseout  = () => tr.style.background = bg;

                    tr.innerHTML = `
                        <td style="padding:12px 20px;">
                            <div style="display:flex;align-items:flex-start;gap:10px;">
                                <div style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0;margin-top:4px;"></div>
                                <div>
                                    <div style="font-size:13px;font-weight:600;color:var(--text-primary,#f1f5f9);">${escHtml(n.matiere || '—')}</div>
                                    <div style="font-size:11px;color:var(--text-muted,#94a3b8);margin-top:3px;display:flex;align-items:center;gap:4px;">
                                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                        ${escHtml(n.enseignant || '—')}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td style="padding:12px 20px;text-align:center;font-size:13px;color:var(--text-muted,#94a3b8);">${coef}</td>
                        <td style="padding:12px 20px;text-align:center;">
                            <span style="display:inline-block;padding:4px 14px;border-radius:999px;font-weight:700;font-family:'Space Mono',monospace;font-size:14px;background:${color}22;border:1px solid ${color}55;color:${color};">
                                ${isNaN(val) ? '—' : val.toFixed(2)}
                            </span>
                        </td>
                        <td style="padding:12px 20px;text-align:center;font-size:13px;color:var(--text-muted,#94a3b8);">${isNaN(val) ? '—' : points.toFixed(2)}</td>
                        <td style="padding:12px 20px;text-align:center;">
                            <span style="font-size:12px;font-weight:600;color:${color};">${escHtml(app)}</span>
                        </td>`;
                    tbody.appendChild(tr);
                });

                // Totaux
                const moyCalc = totalCoef > 0 ? (totalPoints / totalCoef).toFixed(2) : '—';
                const mTot    = getMention(moyCalc);
                document.getElementById('bul-total-coef').textContent    = totalCoef;
                document.getElementById('bul-total-points').textContent  = totalPoints.toFixed(2);
                document.getElementById('bul-total-moyenne').textContent = moyCalc;
                document.getElementById('bul-total-moyenne').style.color = noteColor(moyCalc);
                document.getElementById('bul-total-mention').textContent = mTot.label;
                document.getElementById('bul-total-mention').style.color = mTot.color;

                // Graphique
                if (bulChart) bulChart.destroy();
                const ctx    = document.getElementById('bulNotesChart').getContext('2d');
                const labels = notes.map(n => n.matiere || '?');
                const values = notes.map(n => parseFloat(n.valeur) || 0);
                const colors = values.map(v => noteColor(v));

                bulChart = new Chart(ctx, {
                    data: {
                        labels,
                        datasets: [
                            {
                                type: 'bar', label: 'Note',
                                data: values,
                                backgroundColor: colors.map(c => c + '33'),
                                borderColor: colors, borderWidth: 2, borderRadius: 8, order: 2,
                            },
                            {
                                type: 'line', label: 'Moyenne générale',
                                data: labels.map(() => isNaN(moy) ? 0 : moy),
                                borderColor: '#fbbf24', borderWidth: 2,
                                borderDash: [6, 4], pointRadius: 0, fill: false, order: 1,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: true, labels: { color: '#94a3b8', font: { size: 11 } } } },
                        scales: {
                            y: { min: 0, max: 20, ticks: { color: '#94a3b8', stepSize: 4 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                            x: { ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { display: false } }
                        }
                    }
                });
            }
        }

        /* ── Ouvrir le bulletin ── */
        async function ouvrirBulletin(btn) {
            const infos = {
                etudiantId: btn.dataset.etudiantId,
                nom:        btn.dataset.nom,
                classe:     btn.dataset.classe,
                tel:        btn.dataset.tel,
                email:      btn.dataset.email,
                classeId:   btn.dataset.classeId,
            };

            // Afficher modal + loading
            const modal = document.getElementById('bulletinModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.getElementById('bul-nom').textContent = infos.nom;
            show('bul-loading');
            hide('bul-chart-wrap');

            try {
                // Fetch l'API classe pour avoir moyenne/rang/notes
                const res = await fetch(`/api/classe/${infos.classeId}/`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                hide('bul-loading');
                show('bul-chart-wrap');

                if (res.ok) {
                    const data = await res.json();
                    remplirBulletin(data, infos);
                } else {
                    remplirBulletin({ eleves: [] }, infos);
                }
            } catch (e) {
                hide('bul-loading');
                show('bul-chart-wrap');
                remplirBulletin({ eleves: [] }, infos);
            }
        }

        /* ── Fermer ── */
        window.closeBulletin = function () {
            document.getElementById('bulletinModal').style.display = 'none';
            document.body.style.overflow = '';
        };

        /* ── Événements ── */
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.open-bulletin-btn');
            if (btn) { e.preventDefault(); ouvrirBulletin(btn); }
        });

        document.getElementById('bulletinModal').addEventListener('click', function (e) {
            if (e.target === this) closeBulletin();
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeBulletin();
        });
    })();
    </script>

    <style>
        * { box-sizing: border-box; }
        .glass-card, .stat-card, .table-card { position:relative; transform:none !important; transition:none !important; }
        .data-table { width:100%; table-layout:fixed; border-collapse:collapse; }
        .data-table th, .data-table td { padding:1rem; text-align:left; vertical-align:middle; overflow:hidden; text-overflow:ellipsis; }
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width:20%; }
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width:12%; }
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width:15%; }
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width:15%; }
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width:10%; }
        .data-table th:nth-child(6), .data-table td:nth-child(6) { width:18%; }
        .data-table th:nth-child(7), .data-table td:nth-child(7) { width:10%; }
        .table-avatar { flex-shrink:0; width:40px; height:40px; }
        .table-wrapper { overflow-x:auto; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; margin-bottom:1.5rem; }
        .content-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:1.5rem; margin-bottom:1.5rem; }
        .background, .orb { position:fixed; z-index:-1; }
        .table-user-name, .table-user-email { display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    </style>
</body>
</html>